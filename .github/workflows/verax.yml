name: VERAX Scan

on:
  push:
  pull_request:

jobs:
  verax-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
      
      - name: Install dependencies
        run: |
          npm ci
          npx playwright install chromium
      
      - name: Run VERAX scan
        if: env.VERAX__URL != ''
        env:
          VERAX__URL: ${{ secrets.VERAX__URL || '' }}
        run: |
          node bin/verax.js --url "$VERAX__URL"
      
      - name: VERAX skipped
        if: env.VERAX__URL == ''
        run: |
          echo "VERAX skipped: no URL provided"
          echo "Set VERAX__URL secret or pass URL to enable scanning"
      
      - name: Print Truth Summary
        if: always() && env.VERAX__URL != ''
        run: |
          # Find the most recent run directory
          if [ -d ".verax/runs" ]; then
            LATEST_RUN=$(ls -t .verax/runs | head -1)
            SUMMARY_PATH=".verax/runs/$LATEST_RUN/summary.json"
            if [ -f "$SUMMARY_PATH" ]; then
              node -e "
                const fs = require('fs');
                const summary = JSON.parse(fs.readFileSync('$SUMMARY_PATH', 'utf-8'));
                const digest = summary.digest || {};
                
                console.log('\n========== VERAX Summary ==========');
                console.log('Run ID: ' + (summary.runId || 'N/A'));
                console.log('URL: ' + (summary.url || 'N/A'));
                console.log('Status: ' + (summary.status || 'N/A'));
                console.log('');
                console.log('Digest:');
                console.log('  Expectations: ' + (digest.expectationsTotal || 0));
                console.log('  Attempted: ' + (digest.attempted || 0));
                console.log('  Observed: ' + (digest.observed || 0));
                console.log('  Silent Failures: ' + (digest.silentFailures || 0));
                console.log('  Coverage Gaps: ' + (digest.coverageGaps || 0));
                console.log('  Unproven: ' + (digest.unproven || 0));
                console.log('  Informational: ' + (digest.informational || 0));
                console.log('');
                console.log('Artifacts: .verax/runs/$LATEST_RUN/');
                console.log('=====================================\n');
              "
            else
              echo "Summary not found in run directory"
            fi
          else
            echo "No runs directory found"
          fi
      
      - name: Upload VERAX artifacts
        if: always() && env.VERAX__URL != ''
        uses: actions/upload-artifact@v4
        with:
          name: odavlverax-scan
          path: .verax/
          retention-days: 30
