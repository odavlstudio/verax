name: VERAX Silent Failure Detection

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  verax-scan:
    name: Scan for Silent Failures
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install VERAX
        run: npm install -g @veraxhq/verax
      
      - name: Run VERAX scan
        id: verax
        run: |
          # Determine URL to scan
          if [ -n "${{ github.event.pull_request.html_url }}" ]; then
            URL="${{ github.event.pull_request.html_url }}"
          else
            URL="https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}"
          fi
          
          # Run VERAX with strict CI settings
          set +e
          verax run "$URL" --ci-mode=strict --min-coverage=0.90
          EXIT_CODE=$?
          set -e
          
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit code mapping for CI:
          # 0  = SUCCESS â†’ pass job
          # 10 = NEEDS_REVIEW (suspected findings) â†’ pass job with warning
          # 20 = FAILURE_CONFIRMED â†’ fail job
          # 30 = FAILURE_INCOMPLETE â†’ fail job
          # 40 = INFRA_FAILURE â†’ fail job
          # 50 = EVIDENCE_VIOLATION â†’ fail job
          # 64 = USAGE_ERROR â†’ fail job
          
          if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 10 ]; then
            echo "âœ… VERAX scan completed (exit $EXIT_CODE)"
            exit 0
          else
            echo "âŒ VERAX scan failed (exit $EXIT_CODE)"
            exit $EXIT_CODE
          fi
      
      - name: Upload VERAX artifacts on failure
        if: failure() && steps.verax.outputs.exit_code >= 20
        uses: actions/upload-artifact@v4
        with:
          name: verax-artifacts-${{ github.run_id }}
          path: .verax/
          retention-days: 7
          if-no-files-found: warn
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && steps.verax.outputs.exit_code != ''
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = parseInt('${{ steps.verax.outputs.exit_code }}');
            let message = '';
            let emoji = '';
            
            if (exitCode === 0) {
              emoji = 'âœ…';
              message = 'VERAX scan completed successfully. No silent failures detected.';
            } else if (exitCode === 10) {
              emoji = 'âš ï¸';
              message = 'VERAX scan found suspected issues that need review. Check the artifacts for details.';
            } else if (exitCode === 20) {
              emoji = 'âŒ';
              message = 'VERAX scan detected confirmed silent failures. Review required before merging.';
            } else if (exitCode === 30) {
              emoji = 'âš ï¸';
              message = 'VERAX scan incomplete. Coverage or observation thresholds not met.';
            } else if (exitCode >= 40) {
              emoji = 'ðŸ’¥';
              message = 'VERAX scan encountered an error. Check the workflow logs for details.';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **VERAX Silent Failure Detection**\n\n${message}\n\n**Exit Code:** ${exitCode}\n\nView artifacts: [verax-artifacts-${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
