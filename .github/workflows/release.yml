##############################################################################
# RELEASE WORKFLOW
#
# Purpose: Publish VERAX to npm registry.
# Runs only on manual dispatch or tag push.
#
# Triggers:
# - workflow_dispatch (manual release)
# - push to tags matching v*
#
# Prerequisites checked:
# - Tests pass (including Vision Compliance)
# - Lint passes
# - Typecheck passes
# - Package version matches tag
# - Release script verification passes
#
# Actions:
# - Pack tarball for smoke testing
# - Publish to npm (if NPM_TOKEN configured)
# - Create git tag
#
# Constitutional Status: LOCKED
# Release is blocked if Vision tests fail.
##############################################################################

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.3.0)'
        required: true
        type: string
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run tests (includes Vision Compliance)
        run: npm test
        # Vision Compliance Tests must pass before release.
        # Release is blocked if VERAX violates constitutional principles.

      - name: Run lint
        run: npm run lint

      - name: Run typecheck
        run: npm run typecheck

      - name: Verify release prerequisites
        run: node scripts/verify-release.js

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Verify package version matches
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          RELEASE_VERSION="${{ steps.version.outputs.version }}"
          if [ "$PACKAGE_VERSION" != "$RELEASE_VERSION" ]; then
            echo "‚ùå Error: Package version ($PACKAGE_VERSION) != Release version ($RELEASE_VERSION)"
            exit 1
          fi
          echo "‚úÖ Version match verified: $PACKAGE_VERSION"

      - name: Pack tarball
        id: pack
        run: |
          VERAX_SKIP_POSTPACK_CLEANUP=1 npm pack
          TARBALL=$(ls veraxhq-verax-*.tgz | head -1)
          echo "tarball=$TARBALL" >> $GITHUB_OUTPUT
          echo "‚úÖ Packed: $TARBALL"

      - name: Smoke test tarball
        run: |
          TARBALL="${{ steps.pack.outputs.tarball }}"
          echo "Testing tarball: $TARBALL"
          
          # Test --version
          echo "Testing: npx $TARBALL --version"
          npx "$TARBALL" --version || exit 1
          
          # Test help (pilot surface: no internal/experimental commands exposed)
          echo "Testing: npx $TARBALL help"
          npx "$TARBALL" help || exit 1
          
          echo "‚úÖ Smoke tests passed"

      - name: Dry-run publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "‚ö†Ô∏è  NPM_TOKEN not configured. Running dry-run without auth."
            npm publish --dry-run
          else
            npm publish --dry-run --access public
          fi

      - name: Publish to npm
        id: publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NODE_AUTH_TOKEN" ]; then
            echo "‚ö†Ô∏è  NPM_TOKEN secret not found. Skipping publish (dry-run only)."
            echo "To publish: set NPM_TOKEN secret in GitHub Settings"
            exit 0
          fi
          
          echo "üì¶ Publishing version ${{ steps.version.outputs.version }} to npm..."
          npm publish --access public
          
          echo "‚úÖ Successfully published to npm"
        continue-on-error: false

      - name: Create git tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag $TAG already exists. Skipping tag creation."
            exit 0
          fi
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "Release $VERSION"
          
          echo "‚úÖ Created tag: $TAG"
          echo "‚ö†Ô∏è  Tag not pushed. Push manually with: git push origin $TAG"

      - name: Release complete
        run: |
          echo "‚úÖ Release ${{ steps.version.outputs.version }} complete!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Vision Compliance: LOCKED ‚úÖ"
          echo "All tests passed before release"

