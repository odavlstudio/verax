name: Guardian PR Gate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  GUARDIAN_BASE_URL: ${{ secrets.GUARDIAN_PREVIEW_BASE_URL }}
  ARTIFACTS_DIR: artifacts/guardian/pr-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  guardian-pr:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-cache-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Restore Playwright browser cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-cache-${{ runner.os }}-v1.48.2
          restore-keys: |
            playwright-cache-${{ runner.os }}-v1.48
            playwright-cache-${{ runner.os }}-

      - name: Install Playwright browsers
        run: npx playwright@1.48.2 install --with-deps chromium

      - name: Validate configuration
        run: |
          set -euo pipefail
          if [ -z "${GUARDIAN_BASE_URL}" ]; then
            echo "::error::GUARDIAN_PREVIEW_BASE_URL secret is required"
            exit 1
          fi
          if ! echo "${GUARDIAN_BASE_URL}" | grep -qE '^https?://'; then
            echo "::error::GUARDIAN_PREVIEW_BASE_URL must be a valid http/https URL"
            exit 1
          fi

      - name: Run Guardian with resilience
        id: guardian-run
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$ARTIFACTS_DIR"
          
          MAX_ATTEMPTS=3
          ATTEMPT=1
          EXIT_CODE=0
          TIMEOUT_MINUTES=5
          TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
          RETRY_DELAYS=(3 8)
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Running Guardian attempt $ATTEMPT/$MAX_ATTEMPTS"
            
            EXIT_CODE=0
            timeout "$TIMEOUT_SECONDS" npx -y @odavl/guardian reality \
              --url "$GUARDIAN_BASE_URL" \
              --artifacts "$ARTIFACTS_DIR" \
              --preset startup \
              --no-trace \
              --no-screenshots \
              --fast || EXIT_CODE=$?
            
            if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 1 ] || [ $EXIT_CODE -eq 2 ]; then
              echo "‚úì Guardian completed with exit code: $EXIT_CODE"
              break
            elif [ $EXIT_CODE -eq 124 ]; then
              echo "::warning::Guardian timed out (exit 124) on attempt $ATTEMPT"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                DELAY=${RETRY_DELAYS[$((ATTEMPT-1))]}
                echo "Waiting ${DELAY}s before retry..."
                sleep "$DELAY"
              fi
            else
              echo "::warning::Guardian failed with exit code $EXIT_CODE on attempt $ATTEMPT"
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                DELAY=${RETRY_DELAYS[$((ATTEMPT-1))]}
                echo "Waiting ${DELAY}s before retry..."
                sleep "$DELAY"
              fi
            fi
            
            ATTEMPT=$((ATTEMPT+1))
          done
          
          if [ $EXIT_CODE -eq 124 ]; then
            echo "::error::Guardian timed out after $MAX_ATTEMPTS attempts"
            exit 124
          fi
          
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          echo "decision_exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

      - name: Extract and validate decision
        id: decision
        shell: bash
        run: |
          set -euo pipefail
          
          EXIT_CODE="${{ steps.guardian-run.outputs.exit_code }}"
          if [ "$EXIT_CODE" -eq 124 ]; then
            echo "::error::Cannot extract decision; Guardian timed out"
            exit 1
          fi
          
          DECISION_FILE=$(find "$ARTIFACTS_DIR" -name "decision.json" -type f | head -n 1)
          if [ -z "$DECISION_FILE" ]; then
            echo "::error::No decision.json found in $ARTIFACTS_DIR"
            ls -la "$ARTIFACTS_DIR" 2>/dev/null || true
            exit 1
          fi
          
          VERDICT=$(node -e "
            const fs = require('fs');
            const d = JSON.parse(fs.readFileSync('$DECISION_FILE', 'utf8'));
            console.log(d.finalVerdict || 'UNKNOWN');
          ")
          
          if ! echo "$VERDICT" | grep -qE '^(READY|FRICTION|DO_NOT_LAUNCH)$'; then
            echo "::error::Invalid verdict: $VERDICT"
            exit 1
          fi
          
          echo "verdict=$VERDICT" >> "$GITHUB_OUTPUT"
          echo "decision_file=$DECISION_FILE" >> "$GITHUB_OUTPUT"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardian-pr-${{ github.run_number }}-${{ github.run_attempt }}
          path: ${{ env.ARTIFACTS_DIR }}
          retention-days: 30
          if-no-files-found: warn

      - name: Comment on PR
        if: always() && github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            const verdict = '${{ steps.decision.outputs.verdict }}' || 'UNKNOWN';
            const exitCode = '${{ steps.guardian-run.outputs.exit_code }}' || 'N/A';
            const artifactName = `guardian-pr-${{ github.run_number }}-${{ github.run_attempt }}`;
            
            const body = [
              '## üõ°Ô∏è Guardian PR Gate',
              `**Verdict:** \`${verdict}\``,
              `**Exit Code:** \`${exitCode}\``,
              `**Artifacts:** ${artifactName}`,
              '',
              '**Policy:**',
              '- \`READY\` ‚úì Safe to merge',
              '- \`FRICTION\` ‚ö†Ô∏è Issues found but may proceed',
              '- \`DO_NOT_LAUNCH\` ‚ùå Blocks merge'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Enforce policy
        shell: bash
        env:
          VERDICT: "${{ steps.decision.outputs.verdict }}"
          EXIT_CODE: "${{ steps.guardian-run.outputs.exit_code }}"
          FAIL_ON: "any"
        run: |
          set -euo pipefail
          
          if [ "$EXIT_CODE" -eq 124 ]; then
            echo "::error::Guardian timed out; blocking PR"
            exit 1
          fi
          
          echo "Verdict=$VERDICT, Fail-On=$FAIL_ON"
          fail=0
          case "$FAIL_ON" in
            none)
              fail=0
              echo "‚úì No failure policy; PR may proceed"
              ;;
            friction)
              if [ "$VERDICT" = "FRICTION" ]; then
                fail=1
                echo "‚ùå FRICTION blocks PR (fail-on=friction)"
              else
                fail=0
                echo "‚úì No friction; PR may proceed"
              fi
              ;;
            risk)
              if [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
                fail=1
                echo "‚ùå DO_NOT_LAUNCH blocks PR (fail-on=risk)"
              else
                fail=0
                echo "‚úì No critical risk; PR may proceed"
              fi
              ;;
            any)
              if [ "$VERDICT" = "FRICTION" ] || [ "$VERDICT" = "DO_NOT_LAUNCH" ]; then
                fail=1
                echo "‚ùå $VERDICT blocks PR (fail-on=any)"
              else
                fail=0
                echo "‚úì READY; PR may proceed"
              fi
              ;;
            *)
              echo "::error::Unknown fail-on value: $FAIL_ON"
              exit 1
              ;;
          esac
          exit $fail
