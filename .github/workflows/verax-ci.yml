name: VERAX CI

on:
  workflow_dispatch:
  pull_request:

jobs:
  test-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run tests
        run: npm test

      - name: Run lint
        run: npm run lint

      - name: Run typecheck
        run: npm run typecheck

      - name: Run pack E2E test
        run: npm test -- test/wave8-pack-e2e.test.js

  verax-scan:
    runs-on: ubuntu-latest
    needs: test-matrix
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start fixture server
        id: fixture-server
        run: |
          node test/helpers/fixture-server.js &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          sleep 3
          echo "url=http://127.0.0.1:8888" >> $GITHUB_OUTPUT
        working-directory: ${{ github.workspace }}

      - name: Run VERAX CI scan
        id: verax
        run: |
          node bin/verax.js run --url ${{ steps.fixture-server.outputs.url }} --src test/fixtures/static-site --out .verax
        working-directory: ${{ github.workspace }}
        continue-on-error: true

      - name: Stop fixture server
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || true
          fi

      - name: Upload VERAX artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verax-artifacts
          path: |
            test/fixtures/static-site/.verax/runs/**/*
            test/fixtures/static-site/.verax/verax-run-*.zip
          retention-days: 7
          if-no-files-found: ignore

      - name: Check VERAX exit code and fail gate
        if: always()
        run: |
          EXIT_CODE=${{ steps.verax.exitcode }}
          if [ "$EXIT_CODE" == "" ]; then
            EXIT_CODE=${{ steps.verax.outcome == 'success' && 0 || 1 }}
          fi
          
          if [ "$EXIT_CODE" == "0" ]; then
            echo "✅ VERAX: VERIFIED - Scan passed"
          elif [ "$EXIT_CODE" == "1" ]; then
            echo "⚠️ VERAX: NO_EXPECTATIONS_FOUND or MEDIUM/LOW findings"
            echo "Gate passes (non-blocking)"
          elif [ "$EXIT_CODE" == "2" ]; then
            echo "❌ VERAX: HIGH severity findings detected"
            echo "Gate fails (blocking)"
            exit 2
          elif [ "$EXIT_CODE" == "4" ]; then
            echo "❌ VERAX: INVALID_CONTEXT - URL does not match project"
            echo "Gate fails (blocking)"
            exit 4
          elif [ "$EXIT_CODE" == "3" ]; then
            echo "❌ VERAX: FATAL error"
            echo "Gate fails (blocking)"
            exit 3
          else
            echo "❌ VERAX: Unexpected exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

