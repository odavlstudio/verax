name: Public Proof (Real URL Execution)

on:
  push:
    branches: [main]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  public-scan-example:
    name: Real Execution - example.com
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install @odavl/guardian (v2.0.0)
        run: npm install --global @odavl/guardian@2.0.0

      - name: Verify Guardian Installation
        run: guardian --version

      - name: Run Guardian Reality Check - example.com
        id: reality-check
        continue-on-error: true
        run: |
          mkdir -p artifacts/public-proof
          # Run Guardian against real public URL
          guardian reality \
            --url https://example.com \
            --preset startup \
            --output-dir artifacts/public-proof \
            2>&1 | tee artifacts/public-proof/command.log
          
          # Capture exit code
          exit_code=$?
          echo "guardian_exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Verify Artifacts Generated
        if: always()
        run: |
          echo "=== Checking artifacts ==="
          if [ -f "artifacts/public-proof/decision.json" ]; then
            echo "✓ decision.json exists"
            cat artifacts/public-proof/decision.json | jq . || cat artifacts/public-proof/decision.json
          else
            echo "✗ decision.json NOT found"
            find artifacts/public-proof -type f -exec echo "{}" \;
          fi
          
          if [ -f "artifacts/public-proof/summary.md" ]; then
            echo "✓ summary.md exists"
            head -20 artifacts/public-proof/summary.md
          else
            echo "✗ summary.md NOT found"
          fi

      - name: Extract Verdict
        id: verdict
        if: always()
        run: |
          if [ -f "artifacts/public-proof/decision.json" ]; then
            VERDICT=$(jq -r '.finalVerdict // "UNKNOWN"' artifacts/public-proof/decision.json)
            echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
            echo "Extracted verdict: $VERDICT"
          else
            echo "verdict=NO_ARTIFACT" >> $GITHUB_OUTPUT
            echo "No decision.json found"
          fi

      - name: Upload Public Proof Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: public-proof-example-com
          path: artifacts/public-proof/
          retention-days: 90

      - name: Report Results
        if: always()
        run: |
          echo "### Public Proof - example.com"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| URL | https://example.com |"
          echo "| Verdict | ${{ steps.verdict.outputs.verdict }} |"
          echo "| Exit Code | ${{ steps.reality-check.outputs.guardian_exit_code }} |"
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |"
          echo "| Artifacts | [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
          echo ""
          if [ -f "artifacts/public-proof/summary.md" ]; then
            echo "### Scan Summary"
            cat artifacts/public-proof/summary.md
          fi

  public-scan-github:
    name: Real Execution - github.com
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install @odavl/guardian (v2.0.0)
        run: npm install --global @odavl/guardian@2.0.0

      - name: Run Guardian Reality Check - github.com
        id: reality-check
        continue-on-error: true
        run: |
          mkdir -p artifacts/public-proof
          guardian reality \
            --url https://github.com \
            --preset startup \
            --output-dir artifacts/public-proof \
            2>&1 | tee artifacts/public-proof/command.log
          
          exit_code=$?
          echo "guardian_exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code

      - name: Verify Artifacts Generated
        if: always()
        run: |
          echo "=== Checking artifacts ==="
          ls -la artifacts/public-proof/ || echo "No artifacts directory"

      - name: Extract Verdict
        id: verdict
        if: always()
        run: |
          if [ -f "artifacts/public-proof/decision.json" ]; then
            VERDICT=$(jq -r '.finalVerdict // "UNKNOWN"' artifacts/public-proof/decision.json)
            echo "verdict=$VERDICT" >> $GITHUB_OUTPUT
          else
            echo "verdict=NO_ARTIFACT" >> $GITHUB_OUTPUT
          fi

      - name: Upload Public Proof Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: public-proof-github-com
          path: artifacts/public-proof/
          retention-days: 90

  proof-summary:
    name: Public Proof Summary
    runs-on: ubuntu-latest
    needs: [public-scan-example, public-scan-github]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: proof-artifacts/

      - name: Generate proof manifest
        run: |
          cat > proof-manifest.json << 'EOF'
          {
            "workflow": "Public Proof (Real URL Execution)",
            "timestamp": "${{ github.event.repository.updated_at }}",
            "runId": "${{ github.run_id }}",
            "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "commits": [
              {
                "sha": "${{ github.sha }}",
                "message": "Public proof verification",
                "author": "${{ github.actor }}"
              }
            ],
            "scans": [
              {
                "url": "https://example.com",
                "preset": "startup",
                "status": "${{ needs.public-scan-example.result }}"
              },
              {
                "url": "https://github.com",
                "preset": "startup",
                "status": "${{ needs.public-scan-github.result }}"
              }
            ]
          }
          EOF
          cat proof-manifest.json

      - name: List all collected artifacts
        run: |
          echo "=== Public Proof Artifacts ==="
          find proof-artifacts -type f -name "*.json" -o -name "*.md" | sort
